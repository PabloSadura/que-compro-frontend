@if (productos().length > 0 && !loading) {
  <div class="space-y-8">
    <div class="bg-sky-50 border border-sky-200 rounded-lg p-6 text-center shadow-sm">
      <div class="flex justify-center items-center gap-x-3">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-sky-500">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.5 21.75l-.398-1.188a3.375 3.375 0 00-2.455-2.456L12.75 18l1.188-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.188a3.375 3.375 0 002.456 2.456L20.25 18l-1.188.398a3.375 3.375 0 00-2.456 2.456z" />
        </svg>
        <h2 class="text-2xl font-bold text-sky-800">An√°lisis IA</h2>
      </div>
      <p class="mt-2 text-slate-700">{{ recomendacionFinal() }}</p>
    </div>
      
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      @for (p of productos(); track p.product_id) {
        <div class="flex flex-col bg-white rounded-lg shadow-md overflow-hidden border border-slate-200 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
          <div class="relative w-full aspect-square bg-slate-100">
            <img [src]="p.thumbnail || 'assets/placeholder.png'" [alt]="p.title" class="h-full w-full object-cover">
            <div class="absolute top-0 left-0 right-0 p-3 flex justify-between">
              <span class="bg-black bg-opacity-70 text-white text-xs font-bold px-3 py-1 rounded-full">{{ p.immersive_details?.brand || p.brand || 'Sin marca' }}</span>
              <span class="bg-white text-slate-800 text-xs font-bold px-3 py-1 rounded-full flex items-center shadow-md gap-x-1">
                {{ p.rating || 'N/A' }}
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-yellow-500"><path fill-rule="evenodd" d="M10.868 2.884c.321-.662 1.134-.662 1.456 0l1.761 3.635 4.02 1.401c.731.256 1.034 1.223.498 1.756l-3.35 2.768 1.107 4.34c.189.742-.602 1.34-1.286.963L10 15.428l-3.567 2.52c-.684.377-1.475-.221-1.286-.963l1.107-4.34-3.35-2.768c-.536-.533-.233-1.499.498-1.756l4.02-1.401 1.76-3.635z" clip-rule="evenodd" /></svg>
              </span>
            </div>
          </div>
          
          <div class="p-4 flex flex-col">
            <p class="fs-semibold text-slate-800">{{ p.immersive_details?.title || p.title }}</p>
            <div   class="my-1 flex flex-col justify-between items-baseline ">
              <p class="text-2xl text-slate-900">{{ p.price }}</p>
              <p class="text-sm text-slate-500">({{ p.reviews || 'Sin' }} reviews)</p>
            </div>
            
            <div class="mt-auto grid grid-cols-2 gap-x-3 pt-4 border-t border-slate-200">
              <button (click)="openProsConsModal(p)" class="inline-flex items-center rounded-full bg-gray-50 px-3 py-2 font-medium text-gray-600 inset-ring inset-ring-gray-500/10 hover:bg-slate-100 transition-colors">
                Pros y Contras
              </button>
              <a [routerLink]="['/product', collectionId(), p.product_id]" class="w-full inline-flex items-center justify-center px-3 py-1 text-sm font-medium rounded-full text-white bg-slate-600 hover:bg-black">
                Ver Detalles
              </a>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
}

@if (isModalOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" (click)="closeModal()">
    <div class="relative bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4" (click)="$event.stopPropagation()">
      <button (click)="closeModal()" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>

      @if (selectedProductForModal(); as p) {
        <h3 class="text-lg font-semibold text-slate-800 mb-4">{{ p.title }}</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
          <div class="space-y-2">
            <h5 class="flex items-center gap-x-2 font-semibold text-green-600">...PROS</h5>
            <ul class="space-y-1 text-slate-600">
              @for (pro of p.pros; track $index) { <li>{{ pro }}</li> }
              @if (!p.pros?.length) { <li class="text-slate-400">No hay pros.</li> }
            </ul>
          </div>
          <div class="space-y-2">
            <h5 class="flex items-center gap-x-2 font-semibold text-red-600">...CONTRAS</h5>
            <ul class="space-y-1 text-slate-600">
              @for (con of p.contras; track $index) { <li>{{ con }}</li> }
              @if (!p.contras?.length) { <li class="text-slate-400">No hay contras.</li> }
            </ul>
          </div>
        </div>
      }
    </div>
  </div>
}